# Transaction Matching Module

## Обзор

Модуль **Transaction Matching** ("Мэтчинг транзакций") предназначен для автоматического и ручного сопоставления переводов между банковскими счетами в разных странах. Это критически важная функция для международных предпринимателей и фрилансеров, которым необходимо отслеживать деньги при их перемещении через границы и различные банковские системы.

## Основные возможности

### 1. **AI-Автоматическое сопоставление**
- Интеллектуальный поиск парных транзакций на основе:
  - Суммы перевода (с учетом конвертации валют)
  - Даты операции (допустимая разница 1-3 дня)
  - Ссылочных номеров (SWIFT, SEPA, внутренние референсы)
  - Данных контрагента
- Показ уровня уверенности (confidence score) для каждого предложенного совпадения
- Пакетное автоматическое сопоставление одним кликом

### 2. **Ручное сопоставление**
- Возможность выбрать любые 2 транзакции для ручного связывания
- Визуальная индикация выбранных транзакций
- Подтверждение сопоставления с автоматическим обновлением статусов

### 3. **Статистика и аналитика**
- **Total Transfers**: общее количество переводов в системе
- **Matched Pairs**: количество успешно сопоставленных пар
- **Unmatched**: количество несопоставленных транзакций
- **AI Suggestions**: количество AI-рекомендаций для сопоставления

### 4. **Фильтрация и поиск**
- Поиск по описанию, контрагенту, референсу
- Фильтр по аккаунту (банковскому счету)
- Фильтр по статусу:
  - All Transactions
  - Unmatched Only (только несопоставленные)
  - Matched Only (только сопоставленные)
  - AI Suggested (только с AI-рекомендациями)

### 5. **Детальный просмотр сопоставлений**
- Визуализация парных транзакций side-by-side
- Отображение:
  - Исходящего перевода (с банком отправителя, страной, суммой)
  - Входящего перевода (с банком получателя, страной, суммой)
  - Уровня совпадения (match confidence)
  - Расхождения в курсе обмена (exchange variance)

### 6. **Управление сопоставлениями**
- Просмотр деталей сопоставленной пары
- Удаление сопоставления (unmatch) при необходимости
- Защита от случайного удаления (подтверждение через toast-уведомление)

## Технические детали

### Структура данных

```typescript
interface Transaction {
  id: number;
  date: string;
  description: string;
  amount: number;
  currency: string;
  account: string;
  accountId: number;
  country: string;
  bank: string;
  type: 'incoming' | 'outgoing';
  counterparty?: string;
  reference?: string;
  status: string;
  matchScore?: number;
  matchedWith?: number;
  isMatched?: boolean;
}
```

### AI-алгоритм сопоставления

Система использует мультифакторный анализ:

1. **Конвертация валют**: автоматическая конвертация сумм через базовую валюту (KZT)
2. **Временной анализ**: проверка соответствия дат (с допуском на банковские задержки)
3. **Семантический анализ**: сравнение референсов и описаний транзакций
4. **Вычисление confidence score**: 
   - 95%+ - высокая уверенность (разница < 3%)
   - 85-94% - средняя уверенность (разница 3-5%)
   - 70-84% - низкая уверенность (разница > 5%)

### Пример использования

```tsx
import { TransactionMatching } from './components/TransactionMatching';

// В Dashboard или другом компоненте
<TransactionMatching accounts={filteredAccounts} />
```

## UI/UX особенности

### Цветовая палитра
- **Сопоставленные транзакции**: зеленые акценты (green-50, green-600)
- **Несопоставленные**: оранжевые акценты (orange-50, orange-600)
- **AI-предложения**: фиолетовые акценты (purple-50, purple-600)
- **Общий фон**: нейтральные серые тона (gray-50, gray-100)

### Иконки (lucide-react)
- `ArrowRightLeft` - основная иконка модуля
- `CheckCircle2` - сопоставленные транзакции
- `AlertCircle` - несопоставленные транзакции
- `Sparkles` - AI-рекомендации
- `Link2` - действие сопоставления
- `Unlink` - действие удаления сопоставления
- `Eye` - просмотр деталей

### Toast-уведомления
- Успешное автоматическое сопоставление
- Успешное ручное сопоставление
- Удаление сопоставления
- Ошибки (например, "Выберите ровно 2 транзакции")

## Интеграция с Dashboard

Модуль интегрирован в Dashboard как отдельная секция:

```typescript
{
  id: 'matching',
  name: language === 'ru' ? 'Мэтчинг транзакций' : 'Transaction Matching',
  icon: ArrowRightLeft
}
```

Позиция в навигации: между "Transactions" и "Currency Control"

## Мультиязычность

Модуль полностью поддерживает русский и английский языки:

- **RU**: "Мэтчинг транзакций", "Сопоставление переводов между счетами в разных странах"
- **EN**: "Transaction Matching", "Match transfers between accounts in different countries"

## Mock данные

Модуль включает реалистичные тестовые данные:
- Переводы USD → RUB (Kaspi Bank → Sberbank)
- Переводы EUR → KZT (TBC Bank → Halyk Bank)
- SWIFT и SEPA транзакции
- Различные референсы и контрагенты

## Будущие улучшения

1. **Машинное обучение**: обучение модели на исторических данных пользователя
2. **Blockchain-верификация**: проверка транзакций через blockchain explorer
3. **Экспорт отчетов**: выгрузка сопоставленных пар в CSV/Excel
4. **Webhook-интеграции**: автоматическое получение данных из банковских API
5. **Расширенна�� аналитика**: статистика по странам, валютам, задержкам переводов

## Поддержка

Для вопросов и предложений по улучшению модуля обращайтесь к документации проекта ФинСплит.

---

**Версия**: 1.0  
**Дата создания**: 9 ноября 2025  
**Автор**: ФинСплит Development Team
